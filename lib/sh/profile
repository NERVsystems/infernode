#!/dis/sh.dis
# emu sh initialisation
load std

# Set command search path
path=(/dis .)

# Get username
user="{cat /dev/user}

# Mount namespace generator (synchronous - must complete before continuing)
mount -ac {mntgen} /n

# Mount LLM filesystem if server is running (optional, non-blocking on failure)
# Server: llm9p on tcp!127.0.0.1!5641
mount -A tcp!127.0.0.1!5641 /n/llm >[2] /dev/null

# Setup home directory based on platform
if {~ $emuhost MacOSX Linux}{
	# For macOS/Linux, mount host filesystem (synchronous)
	trfs '#U*' /n/local >[2] /dev/null
	# Get actual HOME from host
	ghome=/n/local/^`{echo 'echo $HOME' | os sh}
	home=$ghome
}{
	# Fallback to /usr/username for other systems
	home=/usr/^$user
	if {! ftest -d $home} {
		mkdir -p $home
	}
}

# Create tmp directory if needed
if {! ftest -d $home/tmp} {
	mkdir -p $home/tmp
}

# Bind tmp to /tmp so applications can find it
bind -bc $home/tmp /tmp

# Change to home directory
cd $home
