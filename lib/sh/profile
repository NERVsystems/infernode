#!/dis/sh.dis
# InferNode shell initialization
load std

# Set command search path
path=(/dis .)

# Get username
user="{cat /dev/user}

# Mount namespace generator (synchronous - must complete before continuing)
mount -ac {mntgen} /n

# Initialize IP networking stack
bind -a '#I' /net

# Start llm9p daemon if not already running, then mount
infraroot=`{cat /env/emuroot}
echo 'pgrep -qf "llm9p.*-addr" || nohup '^$infraroot^'/../llm9p/llm9p -backend cli -addr :5640 </dev/null >/dev/null 2>&1 &' | os sh >[2] /dev/null
sleep 1
mount -A 'tcp!127.0.0.1!5640' /n/llm >[2] /dev/null

# Start speech file server (TTS/STT via /n/speech)
/dis/veltro/speech9p.dis -e cmd &

# Setup home directory based on platform
if {~ $emuhost MacOSX Linux}{
	# For macOS/Linux, mount host filesystem (synchronous)
	trfs '#U*' /n/local >[2] /dev/null
	# Get actual HOME from host
	ghome=/n/local/^`{echo 'echo $HOME' | os sh}
	home=$ghome
}{
	# Fallback to /usr/username for other systems
	home=/usr/^$user
	if {! ftest -d $home} {
		mkdir -p $home
	}
}

# Create tmp directory if needed
if {! ftest -d $home/tmp} {
	mkdir -p $home/tmp
}

# Bind tmp to /tmp so applications can find it
bind -bc $home/tmp /tmp

# Clean up stale temp files from previous sessions
# These accumulate when apps crash (ORCLOSE doesn't trigger on abnormal exit)
# Pattern: /tmp/[A-Z]{pid}.{user}xenith, acme, blks (4-char user prefix)
for f in /tmp/*.????xenith /tmp/*.????acme /tmp/*.????blks {
	rm $f >[2] /dev/null
}

# Change to home directory
cd $home
