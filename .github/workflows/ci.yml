name: CI

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ─────────────────────────────────────────────
  # Linux AMD64: Full bootstrap build from source
  # ─────────────────────────────────────────────
  linux-amd64:
    name: Linux AMD64 Build & Test
    runs-on: ubuntu-latest
    timeout-minutes: 30
    env:
      ROOT: ${{ github.workspace }}

    steps:
    - uses: actions/checkout@v4

    - name: Install build dependencies
      run: sudo apt-get update && sudo apt-get install -y build-essential

    - name: Bootstrap build (mk, libraries, limbo, emulator)
      run: |
        chmod +x build-linux-amd64.sh
        ./build-linux-amd64.sh

    - name: Verify emulator binary
      run: |
        test -x emu/Linux/o.emu || { echo "Emulator not built"; exit 1; }
        file emu/Linux/o.emu
        test -x Linux/amd64/bin/limbo || { echo "Limbo compiler not built"; exit 1; }

    - name: Compile test suite
      run: |
        LIMBO="$ROOT/Linux/amd64/bin/limbo"

        # Build the testing module first
        mkdir -p dis/tests dis/lib

        # Build testing library
        if [ -d tests/testing ]; then
          cd tests/testing
          for f in *.b; do
            [ -f "$f" ] && "$LIMBO" -I "$ROOT/module" -o "$ROOT/dis/lib/${f%.b}.dis" "$f" 2>&1 || true
          done
          cd "$ROOT"
        fi

        # Build test runner and test files
        cd tests
        for f in *.b; do
          name="${f%.b}"
          echo "Compiling $f..."
          "$LIMBO" -I "$ROOT/module" -o "$ROOT/dis/tests/$name.dis" "$f" 2>&1 || true
        done
        cd "$ROOT"

        # Verify runner was compiled
        test -f dis/tests/runner.dis || { echo "Test runner not compiled"; exit 1; }

    - name: Run test suite
      run: |
        echo "Running test suite inside Inferno emulator..."
        timeout 120 ./emu/Linux/o.emu -r . /dis/tests/runner.dis -v 2>&1 || {
          exitcode=$?
          if [ $exitcode -eq 124 ]; then
            echo "Test suite timed out"
            exit 1
          fi
          # Emulator exits non-zero on 'raise "fail:..."' - check output
          exit $exitcode
        }

    - name: Upload Linux build artifacts
      uses: actions/upload-artifact@v4
      if: success()
      with:
        name: infernode-linux-amd64
        path: |
          emu/Linux/o.emu
          Linux/amd64/bin/limbo
          Linux/amd64/bin/mk
        retention-days: 14

  # ─────────────────────────────────────────────
  # macOS ARM64: Build using shipped toolchain
  # ─────────────────────────────────────────────
  macos-arm64:
    name: macOS ARM64 Build & Test
    runs-on: macos-latest
    timeout-minutes: 30
    env:
      ROOT: ${{ github.workspace }}

    steps:
    - uses: actions/checkout@v4

    - name: Build mk
      run: |
        chmod +x makemk.sh
        ./makemk.sh
        test -x MacOSX/arm64/bin/mk || { echo "mk build failed"; exit 1; }

    - name: Build system libraries
      run: |
        export PATH="$ROOT/MacOSX/arm64/bin:/usr/bin:/bin"

        for dir in lib9 libbio libmp libsec libmath; do
          echo "Building $dir..."
          (cd $dir && "$ROOT/MacOSX/arm64/bin/mk" install) || exit 1
        done

    - name: Build limbo compiler
      run: |
        export PATH="$ROOT/MacOSX/arm64/bin:/usr/bin:/bin"
        (cd limbo && "$ROOT/MacOSX/arm64/bin/mk" install) || exit 1
        test -x MacOSX/arm64/bin/limbo || { echo "limbo not found"; exit 1; }

    - name: Build libinterp and remaining libraries
      run: |
        export PATH="$ROOT/MacOSX/arm64/bin:/usr/bin:/bin"
        (cd libinterp && "$ROOT/MacOSX/arm64/bin/mk" install) || exit 1
        for dir in libkeyring libdraw libmemdraw libmemlayer; do
          (cd $dir && "$ROOT/MacOSX/arm64/bin/mk" install) || true
        done

    - name: Build headless emulator
      run: |
        export PATH="$ROOT/MacOSX/arm64/bin:/usr/bin:/bin"
        cd emu/MacOSX
        OBJTYPE=arm64 SYSTARG=MacOSX SHELL=/bin/sh "$ROOT/MacOSX/arm64/bin/mk" -f mkfile-g
        test -f o.emu || { echo "Headless emulator build failed"; exit 1; }

    - name: Compile essential dis files
      run: |
        LIMBO="$ROOT/MacOSX/arm64/bin/limbo"

        # emuinit + shell
        "$LIMBO" -I./module -gw appl/cmd/emuinit.b && cp emuinit.dis dis/
        (cd appl/cmd/sh && ../../../MacOSX/arm64/bin/limbo -I../../../module -gw sh.b && cp sh.dis ../../../dis/)

        # Core commands
        for cmd in cat ls pwd echo date; do
          "$LIMBO" -I./module -gw "appl/cmd/$cmd.b" && cp "$cmd.dis" dis/ || true
        done

        # Essential libraries
        mkdir -p dis/lib
        cd appl/lib
        for f in bufio.b string.b readdir.b arg.b; do
          "../../MacOSX/arm64/bin/limbo" -I../../module -gw "$f" || true
        done
        cp bufio.dis string.dis readdir.dis arg.dis ../../dis/lib/ 2>/dev/null || true
        cd "$ROOT"

    - name: Compile test suite
      run: |
        LIMBO="$ROOT/MacOSX/arm64/bin/limbo"
        mkdir -p dis/tests

        # Build testing library
        if [ -d tests/testing ]; then
          cd tests/testing
          for f in *.b; do
            [ -f "$f" ] && "$LIMBO" -I "$ROOT/module" -o "$ROOT/dis/lib/${f%.b}.dis" "$f" 2>&1 || true
          done
          cd "$ROOT"
        fi

        # Build test files
        cd tests
        for f in *.b; do
          name="${f%.b}"
          echo "Compiling $f..."
          "$LIMBO" -I "$ROOT/module" -o "$ROOT/dis/tests/$name.dis" "$f" 2>&1 || true
        done
        cd "$ROOT"

        test -f dis/tests/runner.dis || { echo "Test runner not compiled"; exit 1; }

    - name: Run test suite
      run: |
        echo "Running test suite inside Inferno emulator..."
        timeout 120 ./emu/MacOSX/o.emu -r . /dis/tests/runner.dis -v 2>&1 || {
          exitcode=$?
          if [ $exitcode -eq 124 ]; then
            echo "Test suite timed out"
            exit 1
          fi
          exit $exitcode
        }

    - name: Run port verification
      run: |
        chmod +x verify-port.sh
        ./verify-port.sh

    - name: Upload macOS build artifacts
      uses: actions/upload-artifact@v4
      if: success()
      with:
        name: infernode-macos-arm64
        path: |
          emu/MacOSX/o.emu
          MacOSX/arm64/bin/limbo
          MacOSX/arm64/bin/mk
        retention-days: 14
