name: Build and Test ARM64 Inferno

on:
  workflow_dispatch:  # Manual trigger only - macOS runners expensive for private repos
  pull_request:
    branches: [ master ]

jobs:
  build-macos:
    runs-on: macos-latest
    env:
      ROOT: ${{ github.workspace }}

    steps:
    - uses: actions/checkout@v4

    - name: Build mk
      run: |
        echo "Building mk in: $ROOT"
        ./makemk.sh
        ls -lh MacOSX/arm64/bin/mk || (echo "mk build failed" && exit 1)

    - name: Build System (Skip Emulator)
      run: |
        export PATH="$ROOT/MacOSX/arm64/bin:/usr/bin:/bin"

        echo "Building system components..."
        # Build each directory individually
        for dir in lib9 libbio libmp libsec libmath; do
          echo "Building $dir..."
          (cd $dir && $ROOT/MacOSX/arm64/bin/mk install) || exit 1
        done

        echo "Building limbo..."
        (cd limbo && $ROOT/MacOSX/arm64/bin/mk install) || exit 1

        echo "Building libinterp..."
        (cd libinterp && $ROOT/MacOSX/arm64/bin/mk install) || exit 1

        echo "Building remaining libraries..."
        for dir in libkeyring libdraw libmemdraw libmemlayer; do
          (cd $dir && $ROOT/MacOSX/arm64/bin/mk install) || true
        done

        echo "Verifying limbo..."
        ls -lh MacOSX/arm64/bin/limbo || (echo "limbo not found" && exit 1)

    - name: Build Headless Emulator
      run: |
        export PATH="$ROOT/MacOSX/arm64/bin:/usr/bin:/bin"

        echo "Building headless emulator (no X11)..."
        cd emu/MacOSX
        OBJTYPE=arm64 SYSTARG=MacOSX SHELL=/bin/sh $ROOT/MacOSX/arm64/bin/mk -f mkfile-g
        ls -lh o.emu || (echo "Headless emulator build failed" && exit 1)
        echo "Emulator built successfully!"

    - name: Compile Essential Dis Files
      run: |
        echo "Compiling essential .dis files..."

        # emuinit
        ./MacOSX/arm64/bin/limbo -I./module -gw appl/cmd/emuinit.b && cp emuinit.dis dis/

        # test program
        ./MacOSX/arm64/bin/limbo -I./module -gw test-stderr.b

        # shell (compile in its directory)
        cd appl/cmd/sh
        ../../../MacOSX/arm64/bin/limbo -I../../../module -gw sh.b && cp sh.dis ../../../dis/
        cd ../../..

        # essential utilities
        for cmd in cat ls pwd; do
          ./MacOSX/arm64/bin/limbo -I./module -gw appl/cmd/$cmd.b && cp $cmd.dis dis/
        done

        ls -lh dis/emuinit.dis dis/sh.dis dis/cat.dis || (echo "Dis compilation failed" && exit 1)

    - name: Build Limbo Libraries (Sample)
      run: |
        # Build essential libraries
        mkdir -p dis/lib
        cd appl/lib
        for f in bufio.b string.b readdir.b arg.b; do
          ../../MacOSX/arm64/bin/limbo -I../../module -gw "$f" || exit 1
        done
        cp bufio.dis string.dis readdir.dis arg.dis ../../dis/lib/
        cd ../..
        ls -lh dis/lib/readdir.dis || (echo "readdir.dis not installed" && exit 1)

    - name: Build Utilities
      run: |
        # Only build if limbo exists
        if [ -f MacOSX/arm64/bin/limbo ]; then
          cd appl/cmd
          for f in *.b; do
            ../../MacOSX/arm64/bin/limbo -I../../module -gw "$f" 2>&1 | grep -v warning || true
          done
        else
          echo "Limbo not built, skipping utility compilation"
        fi

    - name: Run Verification
      run: |
        # Run verification
        chmod +x verify-port.sh
        ./verify-port.sh

    - name: Test Basic Functionality
      run: |
        # Test if emulator runs without crashing
        if [ -f emu/MacOSX/o.emu ] && [ -f test-stderr.dis ]; then
          echo "Testing emulator..."
          timeout 5 ./emu/MacOSX/o.emu -r. test-stderr.dis 2>&1 > /tmp/test-output.txt || true
          # If it ran for 5s and produced output, that's success
          if [ -s /tmp/test-output.txt ]; then
            echo "✅ Emulator runs and produces output"
            cat /tmp/test-output.txt | head -20
          else
            echo "⚠️ Emulator ran but no output (might be timing)"
          fi
        else
          echo "Test files missing, skipping"
        fi

    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      if: success()
      with:
        name: inferno-arm64-macos
        path: |
          emu/MacOSX/o.emu
          MacOSX/arm64/bin/*
